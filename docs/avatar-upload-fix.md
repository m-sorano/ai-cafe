# アバターアップロード機能の修正ガイド

## 問題の概要

アバターのアップロード機能に関連して、以下のエラーが発生することがあります：

1. **「Bucket not found」エラー**：avatarsバケットが存在しないか、アクセスできない
2. **「new row violates row-level security policy」エラー**：RLSポリシーによりアップロードが拒否される

これらの問題を解決するための手順を以下に示します。

## 1. 「Bucket not found」エラーの修正

### 原因
- Supabaseのストレージバケット「avatars」が存在しない
- または、バケットへのアクセス権限が適切に設定されていない

### 解決方法

#### A. Supabaseダッシュボードから修正

1. Supabaseプロジェクトのダッシュボードにログイン
2. 左側のメニューから「Storage」を選択
3. 「New Bucket」ボタンをクリック
4. バケット名に「avatars」と入力
5. 「Public bucket」オプションをオン（チェック）にする
6. 「Create bucket」ボタンをクリック

#### B. スクリプトから修正

提供されている修正スクリプトを実行します：

```bash
node scripts/run-fix-permissions.js
```

このスクリプトは、バケットの存在を確認し、存在しない場合は作成します。

## 2. RLSポリシー違反エラーの修正

### 原因
- ストレージバケットに適切なRLSポリシーが設定されていない
- プロフィールテーブルに適切なRLSポリシーが設定されていない

### 解決方法

#### A. Supabaseダッシュボードから修正

1. **ストレージのRLSポリシーを修正**：
   - Supabaseダッシュボードの「SQL Editor」を開く
   - `reset-storage-permissions.sql`の内容をコピーして実行

2. **プロフィールテーブルのRLSポリシーを修正**：
   - 同様に`reset-profiles-permissions.sql`の内容をコピーして実行

#### B. スクリプトから修正（推奨）

提供されている**リセット**スクリプトを実行します：

```bash
node scripts/run-reset-permissions.js
```

このスクリプトは以下の操作を行います：
- avatarsバケットの存在確認と作成
- ストレージのRLSポリシーを完全にリセット
- プロフィールテーブルのRLSポリシーを完全にリセット
- テストファイルをアップロードして機能を確認

## 修正内容の詳細

### 1. ストレージのRLSポリシー（reset-storage-permissions.sql）

最新の修正では、以下のアプローチを採用しています：

- 既存のすべてのポリシーを削除
- RLSを一時的に無効化
- 英語のポリシー名を使用（日本語のポリシー名が問題を引き起こす可能性があるため）
- 誰でもアバター画像を参照できるポリシーを設定
- 誰でもアバター画像をアップロードできるポリシーを設定
- RLSを再度有効化

### 2. プロフィールテーブルのRLSポリシー（reset-profiles-permissions.sql）

プロフィールテーブルにも同様のアプローチを採用：

- 既存のすべてのポリシーを削除
- RLSを一時的に無効化
- 英語のポリシー名を使用
- 誰でもプロフィールを参照できるポリシーを設定
- ユーザーは自分のプロフィールを作成・更新できるポリシーを設定
- RLSを再度有効化
- 新規ユーザー登録時にプロフィールを自動作成するトリガーを設定

## トラブルシューティング

### エラーが解決しない場合

1. **ブラウザのコンソールでエラーを確認**：
   - ブラウザの開発者ツール（F12）を開く
   - コンソールタブでエラーメッセージを確認

2. **より詳細なエラー情報を取得**：
   - `profile.js`の`uploadAvatar`関数にはエラーハンドリングが強化されています
   - エラーメッセージを確認して、具体的な問題を特定

3. **Supabaseのログを確認**：
   - Supabaseダッシュボードの「Database」→「Logs」で詳細なエラーログを確認

4. **RLSポリシーが正しく適用されているか確認**：
   - Supabaseダッシュボードの「Authentication」→「Policies」でポリシーを確認

### 一般的なエラーと解決策

#### 「Bucket not found」エラー
- バケットが存在するか確認
- バケットの名前が正確に「avatars」（小文字）であることを確認

#### 「new row violates row-level security policy」エラー
- ユーザーが正しく認証されているか確認
- RLSポリシーが正しく設定されているか確認
- `run-reset-permissions.js`スクリプトを実行して、RLSポリシーを完全にリセット

#### 「JWT token is invalid」エラー
- ユーザーセッションが有効か確認
- アプリケーションを再起動してセッションをリフレッシュ

### 最終的な解決策

上記の方法でも問題が解決しない場合は、以下の最終的な解決策を試してください：

1. **RLSを完全に無効化する**：
   ```sql
   -- ストレージのRLSを無効化
   ALTER TABLE storage.objects DISABLE ROW LEVEL SECURITY;
   
   -- プロフィールテーブルのRLSを無効化
   ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;
   ```

2. **Supabaseプロジェクトのキャッシュをクリア**：
   - ブラウザのキャッシュをクリア
   - アプリケーションを再起動
   - Supabaseダッシュボードで「Project Settings」→「API」を選択
   - 「JWT Secret」の下にある「Rotate JWT Secret」ボタンをクリック（注意: 全ユーザーがログアウトされます）

## 修正後の確認

1. アプリケーションを再起動
2. ログインして、プロフィールページに移動
3. アバター画像をアップロードしてみる
4. エラーが発生しなければ、修正は成功

## 注意事項

- RLSポリシーを変更した場合、セキュリティへの影響を考慮してください
- 本番環境に適用する前に、テスト環境で十分にテストしてください
- 環境変数（`NEXT_PUBLIC_SUPABASE_URL`と`SUPABASE_SERVICE_ROLE_KEY`）が正しく設定されていることを確認してください

## 追加のヘルプ

さらに問題が解決しない場合は、以下の情報を含めて報告してください：

1. 具体的なエラーメッセージ
2. 発生時の操作手順
3. ブラウザとバージョン
4. 実行環境（開発/本番）
